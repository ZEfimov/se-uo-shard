use uo;
use os;
use cfgfile;
use unicode;
include ":attributes:attributes";
include ":containers:containers";
include ":itemutils:itemdesc";
include ":magery:tnmagery";
include ":magery:basicMagery";
include "include/say";
include ":charactercreation:habilidades";
include "include/facings";
include ":tn:cooldown";

program SpellStarter(params)
	var mobile    := params[1]; // Caster
	var spellinfo := params[2]; // spellinfo
	var item      := params[3]; // item que usou pra castar o spell (item, book, varinha ou nada)
	var targ      := params[4];

	if (spellinfo.id != error) //le o cfg pra escrever a info
		writeSpellInfo(mobile, spellinfo);
	endif

	if ( GetObjProperty(mobile, "metamorfose") != error )
		SendSysMessageEx(mobile, "Esta metamorfoseado e incapaz de castar magias.");
		return 1;
	elseif (getCooldown(mobile, spellinfo.name) > 0)
		PrintTextPrivate(mobile, "'Magia em Cooldown!'", mobile, SSM_FAIL);
		return 1;
	elseif ( !Attach(mobile) )
		SendSysMessageEx(mobile, "Voce ja esta fazendo alguma coisa.", SSM_FAIL);
		return 0;
	endif

	// Already casting?
	if ( GetObjProperty(mobile, "#Casting") )
		SendSysMessageEx(mobile, "Voce nao pode invocar um encanto agora.", SSM_FAIL);
		return 0;
	elseif ( mobile.frozen )
      SendSysMessageEx(mobile, "Voce nao pode invocar um encanto paralisado.", SSM_FAIL);
      EraseObjProperty(mobile, "#Casting");
      return 0;
   endif

   SetObjProperty(mobile, "#Casting", 1);
   spellinfo.mana := spellinfo.mana + Cint(spellinfo.mana*GetObjProperty(mobile, "#manapenalty")/100);

   // consume mana and reagents
   if (!mobile.npctemplate)
      if ( mobile.squelched && spellinfo.powerwords )
         SendSysMessageEx(mobile, "Voce precisa falar devido os componentes verbais da magia.", SSM_FAIL);
         FailSpell(mobile);
         return 0;
      elseif ( !EquipmentCheck(mobile) )
         SendSysMessageEx(mobile, "Suas maos precisam estar livres para gesticular os componentes gestuais necessarios para a magia.", SSM_FAIL);
         FailSpell(mobile);
         return 0;
      elseif ( !ConsumeMana(mobile, spellinfo.mana) )
         SendSysMessageEx(mobile, "Voce nao possui energia arcana suficiente em seu corpo para invocar esta magia!", SSM_FAIL);
         FailSpell(mobile);
         return 0;
      elseif ( !TNCheckReagents(mobile, spellinfo, item) && mobile.cmdlevel < 3)
         SendSysMessageEx(mobile, "Voce nao possui os componentes materiais necessarios para invocacao desta magia arcana.", SSM_FAIL);
         HealMana(mobile, cint(spellinfo.mana*0.5));
         FailSpell(mobile);
         return 0;
      endif
   endif
   
   mobile.hidden := 0;
   
   // start casting
   if (spellinfo.powerwords && !GetObjProperty(mobile, "#magiasilenciosa") ) //checa powerwords
      PrintText(mobile, spellinfo.powerwords);
   endif

   var moveCheck := Start_Script(":magery:moveCheck", array{mobile, Getpid()});
   var orig_hp := AP_GetVital(mobile, "Hits");

   var cycles := spellinfo.cycles;
   while(cycles)
      // If mobile is injured and does not have the protection spell on, fail the spell
      if ( orig_hp > AP_GetVital(mobile, "Hits") && randomdiceroll("1d100") < 75)
         SendSysMessageEx(mobile, "Voce esta tendo problemas para se concentrar na magia.", SSM_FAIL);
         cycles += 1;
      endif
      orig_hp := AP_GetVital(mobile, "Hits");

      // Check if we recieved an event from moveCheck_script, which means the mobile moved while targetting
      if ( Events_Waiting() )
         SendSysMessageEx(mobile, "Voce nao conseguiu se concentrar o suficiente para invocar esta magia.", SSM_FAIL);
         FailSpell(mobile);
         HealMana(mobile, cint(spellinfo.mana*0.5));
         return 0;
      endif

      // Perform casting animation depending on spell target
      if (GetObjProperty(mobile, "#magiasilenciosa") == error)
         case ( spellinfo.range )
            "Distancia":
               PerformAction(mobile, ANIM_CAST_DIR);
               break;
            "Area":
               PerformAction(mobile, ANIM_CAST_AREA);
               break;
            default:
               PerformAction(mobile, ANIM_CAST_DIR);
         endcase
      endif

      cycles -= 1;
      sleepms(750);
   endwhile

   moveCheck.kill();

   // Targeting
   // if (item.isA(POLCLASS_ITEM) && item.objtype != 0x790c && item.objtype != 0x2253)
   //    SubtractAmount(item, 1);
   // endif

   if (!targ)
      targ := ChooseTarget(who, spellinfo);
      if (!targ)
         SendsysMessageEx(mobile, "Voce cancelou a magia.", SSM_FAIL);
         FailSpell(mobile);
         return ;
      endif
   endif	

   if (spellinfo.alvo != "Area" && !CheckLineOfSight(mobile, targ)) //checa se n�o � magia em �rea
      SendsysMessageEx(mobile, "Voce nao ve o alvo.", SSM_FAIL);
      FailSpell(mobile);
      return 1;
   else //sen�o
      if (!CheckLOSAt(mobile, targ.x, targ.y, targ.z)) //verifica se o ponto � v�sivel
         SendsysMessageEx(mobile, "O ponto que voce selecionou esta fora da sua linha de visao.", SSM_FAIL);
         FailSpell(mobile);
         return 1;
      endif
   endif

   var attribute := INTELLIGENCE;
   if (spellinfo.use_wisdom)
      attribute := WISDOM;
   endif

   spellinfo.dice_roll = rollAttrDice(mobile, attribute) + getProfiencyBonus(mobile);
   if (spellinfo.script != error)
      var e := Start_Script(spellinfo.script, array{mobile, spellinfo});
      //sendsysmessage(mobile, " " );
      return;
   else
      Print(mobile, " " + spellinfo);
   endif  
   SetCooldown(mobile, spellinfo.name, spellinfo.cooldown);

   EraseObjProperty(mobile, "#magiasilenciosa");
   EraseObjProperty(mobile, "#Casting");
endprogram

function ChooseTarget(who, spellinfo)
   if (spellinfo.alvo == "Self")
      targ := mobile;
   elseif (spellinfo.alvo == "Unico")
      SendSysMessageEx(mobile, "Escolha o alvo da magia.", SSM_REQUEST);
      var noto := TGTOPT_NEUTRAL;
      if (spellinfo.align == "Harmful")
         noto := TGTOPT_HARMFUL;
      elseif (spellinfo.align == "Helpful")
         noto := TGTOPT_HELPFUL;
      endif
      targ := Target(mobile, noto);
      if (GetCooldown(targ, "repeal") > 0)
         SendSysMessageEx(mobile, "O alvo esta invulneravel a magias.", SSM_FAIL);
         return 0;
      endif
      TurnObjectToward(mobile, targ.x, targ.y);
   elseif (spellinfo.alvo == "Area")
      while (1)
         PrintTextPrivate(mobile, "'Escolha o Ponto Alvo.'", mobile, SSM_INFO);
//   		SendSysMessageEx(mobile, "Escolha o ponto onde a magia sera castada.", SSM_REQUEST);
         targ := TargetCoordinates(mobile);
         TurnObjectToward(mobile, targ.x, targ.y);
         if(!spellinfo.radius)
            break;
         elseif (CoordinateDistance(mobile.x, mobile.y, targ.x, targ.y) < spellinfo.radius)
            break;
         else
            SendSysMessageEx(mobile, "Muito Distante!", SSM_FAIL;
         endif
      endwhile
   endif

   return targ;
endfunction